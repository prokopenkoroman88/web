<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Как переопределить плагин (перехватчик)</title>
	<link rel="stylesheet" href="../../css/style.css">
</head>
<body>

<!--
<h1 class="h1">
	<div class="en">
		
	</div>
	<div class="ru">
		
	</div>
</h1>


<div class="p">
	<div class="en">
		
	</div>
	<div class="ru">
		
	</div>
</div>



<h2 class="h2">
	<div class="en">
		
	</div>
	<div class="ru">
		
	</div>
</h2>

<div class="p">
	<div class="en">
		
	</div>
	<div class="ru">
		
	</div>
</div>


-->

<a href="https://www.czettner.com/magento/2018/06/16/how-to-override-plugin-interceptor.html">Оригинал</a>
<!--
<h1 class="h1">
	<div class="en">
		A Module in Magento 2
	</div>
	<div class="ru">
		Модули в Magento 2
	</div>
</h1>
-->

<div class="h1"><div class="en">How to override a plugin (interceptor)</div><div class="ru">Как переопределить плагин (перехватчик)</div></div>
<div class="p"><div class="en"> 2 minute read (June 16, 2018)</div><div class="ru"> 2 минуты чтения</div></div>
<div class="p"><div class="en">Magento 2 plugins are fundamental parts of the system. Magento plugins are the name for interceptors and plugin code is autogenerated and stored in the /generation folder. It was discussed many times in conferences that plugins are now the preferred way to extend the functionality of the core rather than overrides (preferences).</div><div class="ru">Плагины Magento 2 являются фундаментальной частью системы. Плагины Magento - это названия перехватчиков, а код плагина автоматически генерируется и сохраняется в папке / generation. На конференциях много раз обсуждалось, что плагины теперь являются предпочтительным способом расширения функциональности ядра, а не переопределением (предпочтениями).</div></div>
<div class="p"><div class="en">Even the core itself is using plugins. One example is Magento\Bundle\Controller\Adminhtml\Product\Initialization\Helper\Plugin\Bundle</div><div class="ru">Даже само ядро ​​использует плагины. Одним из примеров является Magento\Bundle\Controller \Adminhtml\Product\Initialization\Helper \Plugin\Bundle.</div></div>
<div class="p"><div class="en">This plugin (interceptor) is intercepting Magento\Catalog\Controller\Adminhtml\Product\Initialization\Helper to initialise bundle item data on the product in the admin. However, what happens when we have to change the way an interceptor works? Plugins are not instantiated through Objectmanager. Interceptors are generated code, rather than individual classes, so there’s no traditional way to set a preference for them and override functionality.</div><div class="ru">Этот плагин (перехватчик) перехватывает Magento \Catalog\Controller\Adminhtml\Product\Initialization\Helper для инициализации данных элемента пакета в продукте в админке. Однако что происходит, когда нам нужно изменить способ работы перехватчика? Плагины не создаются через Objectmanager. Перехватчики - это сгенерированный код, а не отдельные классы, поэтому нет традиционного способа установить для них предпочтение и переопределить функциональность.</div></div>
<div class="p"><div class="en">One way to change functionality of a plugin is to disable it entirely and redefine a plugin for the same type. To disable a plugin, one can easily do it using the disable attribute. Place this code in app/code/{Vendor}/{Module}/etc/adminhtml/di.xml:</div><div class="ru">Один из способов изменить функциональность плагина - полностью отключить его и переопределить плагин для того же типа. Чтобы отключить плагин, это легко сделать с помощью атрибута disable. Поместите этот код в app /code/{Vendor}/{Module}/etc/adminhtml/di.xml:</div></div>


<code class="code-xml">
<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <type name="Magento\Catalog\Controller\Adminhtml\Product\Initialization\Helper">
        <plugin name="Bundle" disabled="true" />
    </type>
</config>
</code>

<div class="p"><div class="en">This code works, because the original xml is defining the plugin name “Bundle” for the same type, which can be disabled:</div><div class="ru">Этот код работает, потому что исходный xml определяет имя плагина «Bundle» для того же типа, которое можно отключить:</div></div>

<code class="code-xml">
?xml version="1.0"?>
<!--
/**
 * Copyright © 2013-2017 Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <type name="Magento\Catalog\Controller\Adminhtml\Product\Initialization\Helper">
        <plugin name="Bundle" type="Magento\Bundle\Controller\Adminhtml\Product\Initialization\Helper\Plugin\Bundle" sortOrder="60" />
    </type>
    ...
</config>
</code>


<div class="p"><div class="en">Depending on what are the requirements, it’s also possible to set the sortOrder attribute for our plugin to a smaller number and return earlier from our “before” interceptor preventing the next plugin in the queue to run. However, just for example, let’s stay with the original idea of overriding the plugin by disabling the original. There’s a known bug in Magento 2 in “processBundleOptionsData” preventing to save the product when there are more than 20 bundle items in a single product. To fix this issue, we are going to override this method in our class:</div><div class="ru">В зависимости от требований, также можно установить для атрибута sortOrder нашего плагина меньшее число и вернуться раньше из нашего перехватчика «до», предотвращая запуск следующего плагина в очереди. Однако, например, давайте останемся с исходной идеей переопределения плагина путем отключения оригинала. В Magento 2 есть известная ошибка в «processBundleOptionsData», которая не позволяет сохранить продукт, если в одном продукте более 20 элементов пакета. Чтобы решить эту проблему, мы собираемся переопределить этот метод в нашем классе:</div></div>


<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">Vendor\Module\Plugin</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AdminHelperBundle</span> <span class="k">extends</span> <span class="nx">\Magento\Bundle\Controller\Adminhtml\Product\Initialization\Helper\Plugin\Bundle</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">processBundleOptionsData</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Product</span> <span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$bundleOptionsData</span> <span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getBundleOptionsData</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$bundleOptionsData</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$bundleOptionsData</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$optionData</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Mods</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$optionData</span><span class="p">[</span><span class="s1">'delete'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$optionData</span><span class="p">[</span><span class="s1">'delete'</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nv">$option</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">optionFactory</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">([</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$optionData</span><span class="p">]);</span>
            <span class="nv">$option</span><span class="o">-&gt;</span><span class="na">setSku</span><span class="p">(</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getSku</span><span class="p">());</span>
            <span class="nv">$option</span><span class="o">-&gt;</span><span class="na">setOptionId</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

            <span class="nv">$links</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nv">$bundleLinks</span> <span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getBundleSelectionsData</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$bundleLinks</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$bundleLinks</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$linkData</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Mods</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'delete'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'delete'</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nv">$link</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkFactory</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">([</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$linkData</span><span class="p">]);</span>

                <span class="k">if</span> <span class="p">((</span><span class="nx">int</span><span class="p">)</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getPriceType</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">\Magento\Bundle\Model\Product\Price</span><span class="o">::</span><span class="na">PRICE_TYPE_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'selection_price_value'</span><span class="p">,</span> <span class="nv">$linkData</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$link</span><span class="o">-&gt;</span><span class="na">setPrice</span><span class="p">(</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'selection_price_value'</span><span class="p">]);</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'selection_price_type'</span><span class="p">,</span> <span class="nv">$linkData</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$link</span><span class="o">-&gt;</span><span class="na">setPriceType</span><span class="p">(</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'selection_price_type'</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nv">$linkProduct</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">productRepository</span><span class="o">-&gt;</span><span class="na">getById</span><span class="p">(</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'product_id'</span><span class="p">]);</span>
                <span class="nv">$link</span><span class="o">-&gt;</span><span class="na">setSku</span><span class="p">(</span><span class="nv">$linkProduct</span><span class="o">-&gt;</span><span class="na">getSku</span><span class="p">());</span>
                <span class="nv">$link</span><span class="o">-&gt;</span><span class="na">setQty</span><span class="p">(</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'selection_qty'</span><span class="p">]);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'selection_can_change_qty'</span><span class="p">,</span> <span class="nv">$linkData</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$link</span><span class="o">-&gt;</span><span class="na">setCanChangeQuantity</span><span class="p">(</span><span class="nv">$linkData</span><span class="p">[</span><span class="s1">'selection_can_change_qty'</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="nv">$links</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$link</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$option</span><span class="o">-&gt;</span><span class="na">setProductLinks</span><span class="p">(</span><span class="nv">$links</span><span class="p">);</span>
            <span class="nv">$options</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$option</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getExtensionAttributes</span><span class="p">();</span>
        <span class="nv">$extension</span><span class="o">-&gt;</span><span class="na">setBundleProductOptions</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setExtensionAttributes</span><span class="p">(</span><span class="nv">$extension</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>
Then the full etc/adminhtml/di.xml:
</p>

<code class="code-xml">
<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <type name="Magento\Catalog\Controller\Adminhtml\Product\Initialization\Helper">
        <plugin name="Bundle" disabled="true" />
        <plugin name="Homeo_Mods_Bundle" type="Vendor\Module\Plugin\AdminHelperBundle" sortOrder="60" disabled="false"/>
    </type>
</config>
</code>

<div class="p"><div class="en">This cause the original plugin to be replaced by the custom one, which is extending the original class and overriding the “processBundleOptionsData” method.</div><div class="ru">Это приводит к замене исходного плагина пользовательским, который расширяет исходный класс и переопределяет метод processBundleOptionsData.</div></div>
<div class="p"><div class="en">As you can see, plugins can be overridden as well, but it’s better to think about this as we are reordering or disabling them rather than overriding. It’s also impossible to define a plugin (interceptor) around another plugin. The ObjectManager does not instantiate plugins, therefore the usual rules do not apply to them. I hope this can save someone time and help to understand basic concepts of the Magento framework.</div><div class="ru">Как видите, плагины также можно переопределить, но лучше подумать об этом, поскольку мы переупорядочиваем или отключаем их, а не переопределяем. Также невозможно определить плагин (перехватчик) вокруг другого плагина. ObjectManager не создает экземпляры подключаемых модулей, поэтому обычные правила к ним не применяются. Я надеюсь, что это поможет кому-то сэкономить время и поможет понять основные концепции фреймворка Magento.</div></div>









<!--

<code class="code-xml">

</code>


<code class="code-php">

</code>

-->


<a href=".\.html">PREV</a>
<a href=".\.html">NEXT</a>

	<script src="../../js/script.js"></script>
</body>
</html>